<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bloch Simulator</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <style>
        :root {
            --primary-color: #0056b3;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-color: #333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Navigation */
        nav {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        nav h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        .nav-links button {
            background: none;
            border: 1px solid rgba(255,255,255,0.5);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 0.9rem;
        }
        .nav-links button:hover {
            background: rgba(255,255,255,0.1);
        }

        /* Container */
        .container {
            flex: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        /* Views */
        .view {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Welcome Page */
        .welcome-hero {
            text-align: center;
            margin-bottom: 3rem;
        }
        .welcome-hero h2 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: var(--primary-color);
        }
        .welcome-hero p {
            font-size: 1.2rem;
            color: #666;
            max-width: 600px;
            margin: 0 auto;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            border: 1px solid #eee;
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0,0,0,0.1);
            border-color: var(--primary-color);
        }

        .card h3 {
            margin-top: 0;
            color: var(--primary-color);
        }

        /* Simulation Controls */
        .controls-panel {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 1.5rem;
            border: 1px solid #e0e0e0;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1.5rem;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #555;
        }

        .control-group input, .control-group select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .control-group input:focus, .control-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0,86,179,0.1);
        }

        /* Plot Area */
        #plot-container {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            min-height: 500px;
            position: relative;
        }

        /* Make sure the pyodide plot fills the container */
        #plot-container div {
            width: 100%;
            display: flex;
            justify-content: center;
        }

        /* Status Bar */
        #status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #333;
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
        }

        .spinner {
            display: inline-block;
            width: 10px;
            height: 10px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden { display: none !important; }

    </style>
</head>
<body>

    <nav>
        <h1>Bloch Simulator</h1>
        <div class="nav-links">
            <button onclick="router('home')">Home</button>
            <button onclick="window.open('https://github.com/lucanagel/bloch_simulator', '_blank')">GitHub</button>
        </div>
    </nav>

    <div class="container">

        <!-- WELCOME VIEW -->
        <div id="home-view" class="view active">
            <div class="welcome-hero">
                <h2>Welcome to the Bloch Simulator</h2>
                <p>Interactive MRI physics simulation in your browser. Explore magnetic resonance concepts with real-time feedback.</p>
            </div>

            <div class="card-grid">
                <div class="card" onclick="router('rf-pulse')">
                    <h3>RF Pulse Explorer</h3>
                    <p>Design and analyze Radio Frequency pulses. Adjust duration, shape, and frequency offsets in real-time.</p>
                </div>

                <div class="card" style="opacity: 0.6; cursor: default;">
                    <h3>Gradient Echo (Coming Soon)</h3>
                    <p>Simulate GRE sequences with variable TR, TE, and flip angles.</p>
                </div>

                <div class="card" style="opacity: 0.6; cursor: default;">
                    <h3>Spin Echo (Coming Soon)</h3>
                    <p>Explore T2 weighting and refueling pulses.</p>
                </div>
            </div>
        </div>

        <!-- RF PULSE SIMULATOR VIEW -->
        <div id="rf-pulse-view" class="view">
            <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0; color: var(--primary-color);">RF Pulse Explorer</h2>
                <button onclick="router('home')" style="padding: 0.5rem 1rem; cursor: pointer;">&larr; Back</button>
            </div>

            <div class="controls-panel">
                <div class="controls-grid">
                    <div class="control-group">
                        <label for="pulse_type">Pulse Type</label>
                        <select id="pulse_type" class="sim-input">
                            <option value="sinc" selected>Sinc</option>
                            <option value="rect">Rectangular</option>
                            <option value="gaussian">Gaussian</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="duration">Duration (ms)</label>
                        <input type="number" id="duration" value="2.0" step="0.1" min="0.1" max="20" class="sim-input">
                    </div>
                    <div class="control-group">
                        <label for="freq_offset">Freq. Offset (Hz)</label>
                        <input type="number" id="freq_offset" value="0" step="50" class="sim-input">
                    </div>
                    <div class="control-group">
                        <label for="t1">T1 (ms)</label>
                        <input type="number" id="t1" value="800" step="50" min="10" class="sim-input">
                    </div>
                    <div class="control-group">
                        <label for="t2">T2 (ms)</label>
                        <input type="number" id="t2" value="100" step="10" min="1" class="sim-input">
                    </div>
                </div>
            </div>

            <div id="plot-container">
                <div id="plot"></div>
            </div>
        </div>

    </div>

    <div id="status-bar">
        <span id="status-text">Initializing environment...</span>
        <span id="version-info">v1.0</span>
    </div>

    <script type="text/javascript">
        // --- CONFIGURATION ---
        const WHEEL_FILENAME = "WHEEL_FILE_PLACEHOLDER";

        // --- GLOBAL STATE ---
        let pyodide = null;
        let isPyodideReady = false;
        let isSimulationPending = false;
        let updateTimer = null;

        // --- ROUTER ---
        function router(viewName) {
            // Hide all views
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));

            // Show target view
            const target = document.getElementById(viewName + '-view');
            if (target) {
                target.classList.add('active');
            }

            // Trigger sim if entering sim view and ready
            if (viewName === 'rf-pulse' && isPyodideReady) {
                triggerSimulation();
            }
        }

        // --- INITIALIZATION ---
        async function init() {
            const status = document.getElementById("status-text");

            try {
                // 1. Load Pyodide
                pyodide = await loadPyodide();
                status.innerText = "Loading libraries...";

                // 2. Install dependencies
                await pyodide.loadPackage(["numpy", "matplotlib", "micropip", "h5py", "scipy"]);

                // 3. Install Bloch Simulator Wheel
                status.innerText = `Installing simulator...`;
                const micropip = pyodide.pyimport("micropip");
                const wheelUrl = new URL(WHEEL_FILENAME, window.location.href).href + "?v=" + Date.now();

                try {
                    await micropip.install(wheelUrl);
                } catch (e) {
                    console.warn("Wheel install failed (expected in dev without build):", e);
                    status.innerText = "Dev mode: Wheel missing (Simulation mock)";
                    // In real deployment, this throws. In dev, we might want to fail gracefully or show a message.
                }

                // 4. Setup Python Environment
                status.innerText = "Starting engine...";
                await pyodide.runPythonAsync(`
import numpy as np
import matplotlib
matplotlib.use("module://matplotlib_pyodide.wasm_backend")
import matplotlib.pyplot as plt
from js import document

# Try importing, otherwise mock for UI testing if wheel is missing
try:
    from blochsimulator import BlochSimulator, TissueParameters, design_rf_pulse
    HAS_BACKEND = True
    sim = BlochSimulator(use_parallel=False)
except ImportError:
    HAS_BACKEND = False
    print("Warning: Backend not found. Using mocks.")

# Global Plot Objects
fig, axs = None, None
lines = {} # Store line objects for updates

def init_plot():
    global fig, axs, lines
    plt.clf()
    # Create 3 subplots with shared x/y where appropriate
    fig, axs = plt.subplots(1, 3, figsize=(10, 4))

    # Customize layout
    fig.patch.set_facecolor('#ffffff')

    # 1. RF Pulse
    axs[0].set_title("RF Pulse Shape")
    axs[0].set_xlabel("Time (ms)")
    axs[0].set_ylabel("Amplitude (uT)")
    lines['rf_real'], = axs[0].plot([], [], label='Real', color='#0056b3')
    lines['rf_imag'], = axs[0].plot([], [], label='Imag', color='#ff9900', alpha=0.7)
    axs[0].legend(loc='upper right', fontsize='small')
    axs[0].grid(True, linestyle='--', alpha=0.5)

    # 2. Magnetization Evolution
    axs[1].set_title("Magnetization (Center)")
    axs[1].set_xlabel("Time (ms)")
    axs[1].set_ylim(-1.1, 1.1)
    lines['mx'], = axs[1].plot([], [], label='Mx', color='r', alpha=0.6)
    lines['my'], = axs[1].plot([], [], label='My', color='g', alpha=0.6)
    lines['mz'], = axs[1].plot([], [], label='Mz', color='b')
    axs[1].legend(loc='upper right', fontsize='small')
    axs[1].grid(True, linestyle='--', alpha=0.5)

    # 3. Frequency Profile
    axs[2].set_title("Excitation Profile")
    axs[2].set_xlabel("Frequency (Hz)")
    axs[2].set_ylim(-0.1, 1.1)
    lines['mxy'], = axs[2].plot([], [], label='Mxy', color='purple')
    lines['mz_prof'], = axs[2].plot([], [], label='Mz', color='gray', linestyle='--')
    axs[2].legend(loc='upper right', fontsize='small')
    axs[2].grid(True, linestyle='--', alpha=0.5)

    plt.tight_layout()

    # Initial draw to attach to DOM
    plt.show()

def update_simulation(t1_ms, t2_ms, duration_ms, freq_offset_hz, pulse_type):
    global fig, axs, lines

    if not HAS_BACKEND:
        return

    # Initialize plot if needed
    if fig is None:
        init_plot()

    # --- PHYSICS ---
    t1_s = t1_ms * 1e-3
    t2_s = t2_ms * 1e-3
    duration_s = duration_ms * 1e-3

    tissue = TissueParameters(name="Gray Matter", t1=t1_s, t2=t2_s)

    # Pulse Design
    npoints = 400
    b1, time_s = design_rf_pulse(
        pulse_type=pulse_type,
        duration=duration_s,
        flip_angle=90,
        time_bw_product=4,
        npoints=npoints,
        freq_offset=freq_offset_hz
    )
    time_ms = time_s * 1e3

    # Simulation
    freq_range = np.linspace(-1000, 1000, 80) # Reduced points for speed
    positions = np.array([[0.0, 0.0, 0.0]])

    gradients = np.zeros((len(time_s), 3))

    result = sim.simulate(
        sequence=(b1, gradients, time_s),
        tissue=tissue,
        frequencies=freq_range,
        positions=positions,
        mode=2
    )

    # --- UPDATE PLOTS ---
    # 1. RF Pulse
    lines['rf_real'].set_data(time_ms, np.real(b1))
    lines['rf_imag'].set_data(time_ms, np.imag(b1))
    axs[0].relim()
    axs[0].autoscale_view()

    # 2. Magnetization (Center Freq)
    center_idx = len(freq_range) // 2
    mx = result['mx'][:, 0, center_idx]
    my = result['my'][:, 0, center_idx]
    mz = result['mz'][:, 0, center_idx]

    lines['mx'].set_data(time_ms, mx)
    lines['my'].set_data(time_ms, my)
    lines['mz'].set_data(time_ms, mz)
    axs[1].set_xlim(0, max(time_ms))

    # 3. Profile
    mx_end = result['mx'][-1, 0, :]
    my_end = result['my'][-1, 0, :]
    mz_end = result['mz'][-1, 0, :]
    mxy_end = np.sqrt(mx_end**2 + my_end**2)

    lines['mxy'].set_data(freq_range, mxy_end)
    lines['mz_prof'].set_data(freq_range, mz_end)

    # Redraw
    # Note: canvas.draw() is ideal, but in WASM backend ensuring a flush is key.
    # plt.show() usually handles updates if the figure is the same manager.
    fig.canvas.draw()
    # Force flush events for UI responsiveness
    fig.canvas.flush_events()
                `);

                isPyodideReady = true;
                status.innerText = "Ready";

                // If we are already on the sim page, run it
                if (document.getElementById('rf-pulse-view').classList.contains('active')) {
                    triggerSimulation();
                }

            } catch (err) {
                status.innerText = "Error: " + err.message;
                console.error(err);
            }
        }

        // --- INTERACTION ---
        function triggerSimulation() {
            if (!isPyodideReady) return;

            // Debounce logic
            if (updateTimer) clearTimeout(updateTimer);

            document.getElementById('status-text').innerHTML = '<span class="spinner"></span>Calculating...';

            updateTimer = setTimeout(async () => {
                const vals = {
                    t1: parseFloat(document.getElementById("t1").value),
                    t2: parseFloat(document.getElementById("t2").value),
                    duration: parseFloat(document.getElementById("duration").value),
                    freq: parseFloat(document.getElementById("freq_offset").value),
                    type: document.getElementById("pulse_type").value
                };

                try {
                    const pyFunc = pyodide.globals.get("update_simulation");
                    if (pyFunc) {
                        pyFunc(vals.t1, vals.t2, vals.duration, vals.freq, vals.type);
                    }
                    document.getElementById('status-text').innerText = "Ready";
                } catch (e) {
                    console.error("Sim Error", e);
                    document.getElementById('status-text').innerText = "Simulation Error";
                }
            }, 50); // 50ms delay
        }

        // Attach listeners
        document.querySelectorAll('.sim-input').forEach(input => {
            input.addEventListener('input', triggerSimulation);
        });

        // Start
        init();

    </script>
</body>
</html>
